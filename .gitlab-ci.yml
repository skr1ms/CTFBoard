workflow:
  rules:
    - changes:
        - backend/**/*
        - frontend/**/*
        - monitoring/**/*
        - deployment/**/*
        - go.mod
        - go.sum
        - .gitlab-ci.yml
      when: always

    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always

stages:
  - build
  - security
  - test
  - deploy
  - cleanup

variables:
  DOCKER_BUILDKIT: "1"
  DOCKER_CLI_IMAGE: docker:cli

  GOLANG_IMAGE: golang:alpine
  MARIADB_IMAGE: mariadb:latest
  REDIS_IMAGE: redis:alpine
  GOLANGCI_LINT_IMAGE: golangci/golangci-lint:v2-alpine
  ALPINE_IMAGE: alpine:latest
  GOSEC_IMAGE: securego/gosec:latest
  TRIVY_IMAGE: aquasec/trivy:latest

  MARIADB_ROOT_PASSWORD: root
  MARIADB_DATABASE: test_board
  MARIADB_USER: test_user
  MARIADB_PASSWORD: test_password
  REDIS_PASSWORD: "test_password"

.docker-login: &docker_login
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin

# Build stage
build:backend:
  stage: build
  image: $DOCKER_CLI_IMAGE
  <<: *docker_login
  script:
    - docker pull "$CI_REGISTRY_IMAGE/backend:latest" || true
    - |
      docker build \
        --cache-from "$CI_REGISTRY_IMAGE/backend:latest" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        -t "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA" \
        -t "$CI_REGISTRY_IMAGE/backend:latest" \
        -f backend/Dockerfile \
        backend/
    - docker push "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
    - docker push "$CI_REGISTRY_IMAGE/backend:latest"
  rules:
    - changes:
        - backend/**/*
        - go.mod
        - go.sum
        - deployment/docker/**/*
      when: always

# Lint stage
lint:backend:
  stage: security
  image: $GOLANGCI_LINT_IMAGE
  variables:
    CGO_ENABLED: "0"
  script:
    - cd backend
    - go mod download
    - golangci-lint run -v --timeout 5m
  rules:
    - changes:
        - backend/**/*
        - go.mod
        - go.sum
      when: always

# Security stage
security:code:
  stage: security
  image:
    name: $GOSEC_IMAGE
    entrypoint: [""]
  script:
    - cd backend
    - go mod download
    - gosec ./...
  rules:
    - changes:
        - backend/**/*
        - go.mod
        - go.sum
      when: always

security:container:
  stage: security
  image:
    name: $TRIVY_IMAGE
    entrypoint: [""]
  variables:
    TRIVY_USERNAME: "$CI_REGISTRY_USER"
    TRIVY_PASSWORD: "$CI_REGISTRY_PASSWORD"
    TRIVY_AUTH_URL: "$CI_REGISTRY"
  script:
    - trivy image --exit-code 0 --severity HIGH,CRITICAL "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
  rules:
    - changes:
        - backend/**/*
        - go.mod
        - go.sum
        - deployment/docker/**/*
      when: always

# Test stage
test:backend:
  stage: test
  image: $GOLANG_IMAGE
  services:
    - name: $MARIADB_IMAGE
      alias: mariadb-test
      variables:
        MARIADB_ROOT_PASSWORD: $MARIADB_ROOT_PASSWORD
        MARIADB_DATABASE: $MARIADB_DATABASE
        MARIADB_USER: $MARIADB_USER
        MARIADB_PASSWORD: $MARIADB_PASSWORD
    - name: $REDIS_IMAGE
      alias: redis-test
      variables:
        REDIS_PASSWORD: $REDIS_PASSWORD

  variables:
    MARIADB_HOST: mariadb-test
    MARIADB_PORT: "3306"
    MARIADB_DB: $MARIADB_DATABASE
    REDIS_HOST: redis-test
    REDIS_PORT: "6379"
    JWT_ACCESS_SECRET: test-access-secret-key-for-ci
    JWT_REFRESH_SECRET: test-refresh-secret-key-for-ci
    APP_NAME: CTFBoard
    APP_VERSION: 1.0.0
    CHI_MODE: test
    LOG_LEVEL: info
    BACKEND_PORT: "8080"
    MIGRATIONS_PATH: migrations
    CGO_ENABLED: "1"
  before_script:
    - apk add --no-cache build-base git netcat-openbsd

    - |
      echo "Waiting for MariaDB..."
      for i in $(seq 1 30); do
        nc -z mariadb-test 3306 && echo "MariaDB is ready!" && break
        echo "Waiting..."
        sleep 2
      done

    - |
      echo "Waiting for Redis..."
      for i in $(seq 1 10); do
        nc -z redis-test 6379 && echo "Redis is ready!" && break
        echo "Waiting..."
        sleep 1
      done

    - cd backend
    - go mod download
  script:
    - go test ./... -v -race
  rules:
    - changes:
        - backend/**/*
        - go.mod
        - go.sum
      when: always

# Deploy stage
deploy:
  stage: deploy
  image: $ALPINE_IMAGE
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H "$DEPLOY_SERVER_IP" >> ~/.ssh/known_hosts || true
    - ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 $DEPLOY_USER@$DEPLOY_SERVER_IP "echo 'SSH connection test'" || true
  script:
    - |
      ssh -o StrictHostKeyChecking=accept-new $DEPLOY_USER@$DEPLOY_SERVER_IP "bash -s" << EOF
        set -e
        cd ~/ctfboard
        
        PREV_HEAD=\$(git rev-parse HEAD)
        git fetch origin main
        git reset --hard origin/main
        
        MONITORING_CHANGED=\$(git diff --name-only \$PREV_HEAD HEAD | grep "^monitoring/" || true)
        
        echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
        
        COMPOSE_FILE="deployment/docker/docker-compose.yml"
        ENV_FILE=".env"
        
        if [ -z "\$ENV_FILE" ]; then
          ENV_FILE=".env"
        fi
        
        touch "\$ENV_FILE"
        
        sed -i '/^BACKEND_IMAGE=/d' "\$ENV_FILE" || true
        
        echo "BACKEND_IMAGE=$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA" >> "\$ENV_FILE"
        
        # Load environment variables (ignoring errors if format is tricky, but basic vars should work)
        set -a
        source "\$ENV_FILE"
        set +a
        
        echo "Generating monitoring/mysqld-exporter/my.cnf..."
        mkdir -p monitoring/mysqld-exporter
        printf "[client]\nuser=\${MARIADB_USER:-admin}\npassword=\${MARIADB_PASSWORD:-admin}\nhost=mariadb\nport=3306\n" > monitoring/mysqld-exporter/my.cnf
        
        docker compose --env-file "\$ENV_FILE" -f "\$COMPOSE_FILE" pull
        
        if [ -n "\$MONITORING_CHANGED" ]; then
          echo "Monitoring configuration changed. Recreating Grafana volume..."
          docker compose --env-file "\$ENV_FILE" -f "\$COMPOSE_FILE" stop grafana || true
          docker compose --env-file "\$ENV_FILE" -f "\$COMPOSE_FILE" rm -f grafana || true
          docker volume rm docker_grafana_data || true
        fi
        
        docker compose --env-file "\$ENV_FILE" -f "\$COMPOSE_FILE" up -d
        
        echo "Ensuring DB privileges..."
        for i in {1..30}; do
          if docker exec mariadb mariadb-admin ping -h 127.0.0.1 -u root -p"\${MARIADB_ROOT_PASSWORD:-root}" --silent; then
            echo "MariaDB is ready. Granting privileges..."
            docker exec mariadb mariadb -u root -p"\${MARIADB_ROOT_PASSWORD:-root}" -e "GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO '\${MARIADB_USER:-admin}'@'%'; FLUSH PRIVILEGES;"
            break
          fi
          echo "Waiting for MariaDB..."
          sleep 2
        done
        
        docker compose --env-file "\$ENV_FILE" -f "\$COMPOSE_FILE" up -d --force-recreate --no-deps backend
        
        docker compose --env-file "\$ENV_FILE" -f "\$COMPOSE_FILE" restart promtail || true
        
        if [ -n "\$MONITORING_CHANGED" ]; then
          echo "Restarting specific monitoring services..."
          docker compose --env-file "\$ENV_FILE" -f "\$COMPOSE_FILE" restart grafana prometheus || true
        fi
        
        docker logout || true
        rm -f ~/.docker/config.json || true
        
        docker image prune -f
      EOF
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# Cleanup stage
docker:gc:
  stage: cleanup
  image: $DOCKER_CLI_IMAGE
  script:
    - docker image prune -f || true
  rules:
    - when: always
  allow_failure: true
